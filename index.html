<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Tracker Pro - Ultimate Sync</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=Noto+Sans+JP:wght@400;700;900&family=JetBrains+Mono:wght@500&display=swap');
        body { font-family: 'Inter', 'Noto Sans JP', sans-serif; background-color: #f8fafc; color: #1e293b; -webkit-tap-highlight-color: transparent; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .glass-card { background: white; border-radius: 1.25rem; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1); }
        .btn-hover { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn-hover:active { transform: scale(0.95); }
        .active-timer { border: 2px solid #6366f1; background: #f5f7ff; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); } 100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); } }
        .modal-overlay { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); }
    </style>
</head>
<body class="p-3 md:p-8 min-h-screen">

    <script id="embedded-data" type="application/json">{}</script>

    <div class="max-w-7xl mx-auto space-y-4 md:space-y-6">
        <!-- Header -->
        <header class="flex flex-col gap-4 glass-card p-4 md:p-6">
            <div class="flex flex-wrap justify-between items-center gap-4">
                <div class="flex items-center gap-3">
                    <div class="bg-indigo-600 p-2 md:p-3 rounded-xl shadow-lg">
                        <svg class="w-6 h-6 md:w-8 md:h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332-4.5 1.253"></path></svg>
                    </div>
                    <div>
                        <h1 class="text-xl md:text-2xl font-black text-slate-800 tracking-tight">Study Tracker Pro</h1>
                        <p id="date-display" class="text-slate-500 text-[10px] md:text-xs font-bold uppercase tracking-wider font-mono"></p>
                    </div>
                </div>
                <div class="flex gap-2 flex-wrap items-center">
                    <div class="flex bg-slate-100 p-1 rounded-xl mr-2">
                        <button onclick="exportJSON()" class="px-3 py-1.5 text-[10px] font-black uppercase text-slate-500 hover:text-indigo-600">JSONæ›¸å‡º</button>
                        <label class="px-3 py-1.5 text-[10px] font-black uppercase text-slate-500 hover:text-indigo-600 cursor-pointer">
                            JSONèª­è¾¼
                            <input type="file" accept=".json" onchange="importJSON(event)" class="hidden">
                        </label>
                    </div>
                    <button onclick="openSyncModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-xl text-sm font-bold btn-hover shadow-lg flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>
                        ã‚¹ãƒãƒ›åŒæœŸ
                    </button>
                    <button onclick="exportAsHtml()" class="bg-emerald-600 text-white px-4 py-2 rounded-xl text-sm font-bold btn-hover shadow-lg">HTMLä¿å­˜</button>
                </div>
            </div>

            <div class="flex flex-col sm:flex-row items-center gap-4 bg-slate-50 p-3 md:p-4 rounded-2xl border border-slate-200">
                <div class="flex flex-1 justify-around w-full items-center">
                    <div class="flex flex-col items-center">
                        <span class="text-[10px] font-black text-slate-400 uppercase mb-1 tracking-widest">ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³</span>
                        <div class="flex items-center gap-2 bg-white px-3 py-1.5 rounded-xl shadow-sm border border-slate-100">
                            <input type="number" id="timer-minutes-input" value="25" min="1" class="w-12 bg-transparent text-lg font-bold text-slate-700 outline-none text-center">
                            <span class="text-slate-300 font-bold">:</span>
                            <span id="global-countdown" class="font-mono text-xl font-bold text-slate-700 w-8 text-center">00</span>
                            <button onclick="toggleGlobalTimer()" id="timer-btn" class="p-1.5 bg-indigo-100 text-indigo-600 rounded-lg btn-hover ml-1">
                                <svg id="timer-icon" class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M4.5 3a.5.5 0 00-.5.5v13a.5.5 0 00.757.429l11-6.5a.5.5 0 000-.858l-11-6.5A.5.5 0 004.5 3z"/></svg>
                            </button>
                        </div>
                    </div>
                    <div class="w-px h-10 bg-slate-200 mx-2"></div>
                    <div class="flex flex-col items-center">
                        <span class="text-[10px] font-black text-slate-400 uppercase mb-1 tracking-widest">æœ¬æ—¥ã®åˆè¨ˆå­¦ç¿’</span>
                        <div id="global-stopwatch" class="font-mono text-xl md:text-2xl font-black text-indigo-600">00:00:00</div>
                    </div>
                </div>
                <input type="date" id="date-picker" class="w-full sm:w-auto border border-slate-200 rounded-xl px-4 py-2 text-sm font-bold outline-none bg-white">
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <div class="lg:col-span-7 space-y-4">
                <section class="glass-card p-4 md:p-6">
                    <div class="flex gap-2 mb-6">
                        <input type="text" id="task-title" placeholder="æ–°ã—ã„ã‚¿ã‚¹ã‚¯å..." class="flex-1 bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm font-bold outline-none">
                        <button onclick="addNewTask()" class="bg-indigo-600 text-white px-6 py-3 rounded-xl font-black text-sm shadow-md btn-hover">è¿½åŠ </button>
                    </div>
                    <div id="task-list" class="space-y-3"></div>
                </section>
            </div>

            <div class="lg:col-span-5 flex flex-col gap-4">
                <div class="glass-card p-4 flex flex-col items-center justify-center min-h-[160px] relative">
                    <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">æœ¬æ—¥ã®é€²æ—çŠ¶æ³</h3>
                    <div class="relative w-28 h-28">
                        <canvas id="todayProgressChart"></canvas>
                        <div id="percentage-label" class="absolute inset-0 flex items-center justify-center pointer-events-none">
                            <span class="text-lg font-black text-slate-800">0%</span>
                        </div>
                    </div>
                </div>
                <div class="glass-card p-4 flex flex-col items-center justify-center min-h-[160px]">
                    <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">å­¦ç¿’æ™‚é–“é…åˆ†</h3>
                    <div class="relative w-full h-28">
                        <canvas id="pieChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <section class="glass-card p-4 md:p-6">
            <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-6">é€±é–“å­¦ç¿’ãƒ­ã‚°</h3>
            <div class="h-48 md:h-64">
                <canvas id="weeklyChart"></canvas>
            </div>
        </section>

        <section class="glass-card overflow-hidden">
            <div class="p-4 border-b border-slate-100 bg-slate-50/50">
                <h3 class="text-[10px] font-black text-slate-700 uppercase tracking-widest">ç´¯è¨ˆå­¦ç¿’åˆ†æ</h3>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left min-w-[600px]">
                    <thead class="bg-slate-50 text-[10px] font-black text-slate-400 uppercase">
                        <tr><th class="px-6 py-4">å­¦ç¿’é …ç›®</th><th class="px-6 py-4">ç´¯è¨ˆæ™‚é–“</th><th class="px-6 py-4">é”æˆåº¦</th><th class="px-6 py-4">è©•ä¾¡</th></tr>
                    </thead>
                    <tbody id="analysis-table" class="divide-y divide-slate-100 text-sm"></tbody>
                </table>
            </div>
        </section>
    </div>

    <!-- Sync Modal -->
    <div id="sync-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-overlay hidden">
        <div class="bg-white w-full max-w-md p-8 rounded-3xl shadow-2xl space-y-6 mx-4">
            <div class="text-center">
                <h2 class="text-2xl font-black text-slate-800">ã‚¹ãƒãƒ›åŒæœŸè¨­å®š</h2>
                <p class="text-xs text-slate-500 font-bold mt-1 uppercase">Cloud Sync</p>
            </div>
            
            <div class="flex flex-col items-center bg-slate-50 p-6 rounded-2xl border-2 border-dashed border-slate-200">
                <div id="qrcode" class="bg-white p-2 rounded-xl shadow-inner mb-4 min-h-[140px] flex items-center justify-center"></div>
                <p class="text-[10px] text-slate-400 font-bold uppercase text-center">ã“ã®QRã‚’ã‚¹ãƒãƒ›ã§ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦ã‚¢ã‚¯ã‚»ã‚¹</p>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-wider block mb-1">å…±æœ‰ã‚­ãƒ¼ (åˆè¨€è‘‰)</label>
                    <div class="flex gap-2">
                        <input type="text" id="sync-key" class="flex-1 font-mono font-bold bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none uppercase" placeholder="ä¾‹: MYSTUDY" oninput="updateQRCode()">
                        <button onclick="generateRandomKey()" class="bg-slate-100 p-3 rounded-xl hover:bg-slate-200">ğŸ²</button>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <button id="cloud-upload-btn" onclick="uploadToCloud()" class="bg-indigo-600 text-white font-black py-4 rounded-2xl shadow-lg btn-hover text-sm">ã‚¯ãƒ©ã‚¦ãƒ‰ã¸ä¿å­˜</button>
                    <button id="cloud-download-btn" onclick="downloadFromCloud()" class="bg-slate-800 text-white font-black py-4 rounded-2xl shadow-lg btn-hover text-sm">èª­è¾¼ï¼ˆåŒæœŸï¼‰</button>
                </div>
            </div>
            
            <button onclick="closeSyncModal()" class="w-full text-slate-400 font-bold py-2 text-sm">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'study-tracker-v5';

        const STORAGE_KEY = 'learning_tracker_v5_final';
        let currentDate = new Date().toLocaleDateString('sv-SE');
        let state = { history: JSON.parse(localStorage.getItem(STORAGE_KEY)) || {}, user: null };
        let charts = {}, timerInterval, timeLeft = 25 * 60, isTimerRunning = false, activeTaskId = null;

        // ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å…¬é–‹
        window.openSyncModal = () => {
            document.getElementById('sync-modal').classList.remove('hidden');
            window.updateQRCode();
        };

        window.closeSyncModal = () => {
            document.getElementById('sync-modal').classList.add('hidden');
        };

        window.updateQRCode = () => {
            const keyInput = document.getElementById('sync-key');
            const key = keyInput.value.trim().toUpperCase();
            if (!key) return;
            try {
                const url = new URL(window.location.href.split('?')[0]);
                url.searchParams.set('key', key);
                const qr = qrcode(0, 'M');
                qr.addData(url.toString());
                qr.make();
                document.getElementById('qrcode').innerHTML = qr.createImgTag(4);
            } catch (e) { console.error("QR Error", e); }
        };

        window.generateRandomKey = () => {
            document.getElementById('sync-key').value = Math.random().toString(36).substring(2, 8).toUpperCase();
            window.updateQRCode();
        };

        window.uploadToCloud = async () => {
            const key = document.getElementById('sync-key').value.trim().toUpperCase();
            if (!key || !state.user) return alert("åˆè¨€è‘‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            const btn = document.getElementById('cloud-upload-btn');
            btn.innerText = "ä¿å­˜ä¸­..."; btn.disabled = true;
            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', key), { 
                    history: state.history, 
                    updatedAt: new Date().toISOString() 
                });
                alert("ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜å®Œäº†ã—ã¾ã—ãŸ");
            } catch (e) { alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ"); }
            finally { btn.innerText = "ã‚¯ãƒ©ã‚¦ãƒ‰ã¸ä¿å­˜"; btn.disabled = false; }
        };

        window.downloadFromCloud = async () => {
            const key = document.getElementById('sync-key').value.trim().toUpperCase();
            if (!key || !state.user) return alert("åˆè¨€è‘‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            const btn = document.getElementById('cloud-download-btn');
            btn.innerText = "èª­è¾¼ä¸­..."; btn.disabled = true;
            try {
                const snap = await getDoc(doc(db, 'artifacts', appId, 'public', 'data', key));
                if (snap.exists()) {
                    state.history = snap.data().history;
                    window.saveToLocal(); 
                    window.refreshUI();
                    alert("åŒæœŸãŒå®Œäº†ã—ã¾ã—ãŸ");
                    window.closeSyncModal();
                } else { alert("ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"); }
            } catch (e) { alert("èª­è¾¼ã«å¤±æ•—ã—ã¾ã—ãŸ"); }
            finally { btn.innerText = "èª­è¾¼ï¼ˆåŒæœŸï¼‰"; btn.disabled = false; }
        };

        window.exportJSON = () => {
            const blob = new Blob([JSON.stringify(state.history, null, 2)], { type: "application/json" });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = `study_data_${currentDate}.json`;
            a.click();
        };

        window.importJSON = (e) => {
            const reader = new FileReader();
            reader.onload = () => {
                try {
                    const data = JSON.parse(reader.result);
                    state.history = data.history || data;
                    window.saveToLocal(); window.refreshUI();
                    alert("èª­ã¿è¾¼ã¿å®Œäº†");
                } catch(err) { alert("å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“"); }
            };
            if(e.target.files[0]) reader.readAsText(e.target.files[0]);
        };

        window.addNewTask = () => {
            const input = document.getElementById('task-title');
            const title = input.value.trim();
            if (!title) return;
            if(!state.history[currentDate]) state.history[currentDate] = [];
            state.history[currentDate].push({ title, seconds: 0, completed: false });
            input.value = ''; window.saveToLocal(); window.refreshUI();
        };

        window.toggleTask = (t) => {
            state.history[currentDate].forEach(x => { if(x.title === t) x.completed = !x.completed; });
            window.saveToLocal(); window.refreshUI();
        };

        window.deleteTask = (t) => {
            state.history[currentDate] = state.history[currentDate].filter(x => x.title !== t);
            window.saveToLocal(); window.refreshUI();
        };

        window.setActive = (t) => {
            activeTaskId = (activeTaskId === t) ? null : t;
            window.refreshUI();
        };

        window.toggleGlobalTimer = () => {
            if (!activeTaskId) return alert("ã‚¿ã‚¹ã‚¯ã‚’é¸æŠï¼ˆâ–¶ãƒœã‚¿ãƒ³ï¼‰ã—ã¦ãã ã•ã„");
            isTimerRunning ? window.stopTimer() : window.startTimer();
        };

        window.startTimer = () => {
            isTimerRunning = true;
            const inputMin = document.getElementById('timer-minutes-input').value;
            if(!timerInterval) timeLeft = parseInt(inputMin) * 60;
            
            timerInterval = setInterval(() => {
                if (timeLeft > 0) {
                    timeLeft--;
                    const t = state.history[currentDate].find(x => x.title === activeTaskId);
                    if (t) t.seconds++;
                    window.updateTimerUI();
                } else {
                    window.stopTimer();
                    alert("ã‚¿ã‚¤ãƒ ã‚¢ãƒƒãƒ—ï¼");
                }
            }, 1000);
            window.updateTimerButton();
        };

        window.stopTimer = () => {
            clearInterval(timerInterval);
            timerInterval = null;
            isTimerRunning = false;
            window.updateTimerButton();
            window.saveToLocal();
        };

        window.updateTimerUI = () => {
            const m = Math.floor(timeLeft / 60);
            const s = timeLeft % 60;
            document.getElementById('timer-minutes-input').value = m;
            document.getElementById('global-countdown').innerText = String(s).padStart(2, '0');
            window.refreshUI();
        };

        window.updateTimerButton = () => {
            document.getElementById('timer-icon').innerHTML = isTimerRunning 
                ? '<rect x="6" y="6" width="8" height="8" fill="currentColor" />' 
                : '<path d="M4.5 3a.5.5 0 00-.5.5v13a.5.5 0 00.757.429l11-6.5a.5.5 0 000-.858l-11-6.5A.5.5 0 004.5 3z"/>';
        };

        window.formatTime = (sec) => {
            const h = Math.floor(sec / 3600), m = Math.floor((sec % 3600) / 60), s = sec % 60;
            return [h, m, s].map(v => String(v).padStart(2, '0')).join(":");
        };

        window.saveToLocal = () => localStorage.setItem(STORAGE_KEY, JSON.stringify(state.history));

        window.initDayData = () => {
            if (!state.history[currentDate]) {
                const dates = Object.keys(state.history).sort();
                const last = dates.filter(d => d < currentDate).pop();
                state.history[currentDate] = last ? state.history[last].map(t => ({...t, seconds: 0, completed: false})) : [];
                window.saveToLocal();
            }
        };

        window.refreshUI = () => {
            window.renderTasks();
            window.updateCharts();
            window.renderAnalysis();
            document.getElementById('date-display').innerText = currentDate;
        };

        window.renderTasks = () => {
            const list = document.getElementById('task-list'); list.innerHTML = '';
            (state.history[currentDate] || []).forEach(task => {
                const isAct = activeTaskId === task.title;
                const div = document.createElement('div');
                div.className = `flex items-center gap-2 p-3 rounded-2xl border ${isAct ? 'active-timer shadow-md' : 'bg-white border-slate-200'} ${task.completed ? 'opacity-50' : ''}`;
                div.innerHTML = `
                    <input type="checkbox" ${task.completed ? 'checked' : ''} onchange="toggleTask('${task.title}')" class="w-5 h-5 accent-indigo-600 rounded-lg">
                    <div class="flex-1 truncate font-bold text-slate-700 text-sm ${task.completed ? 'line-through' : ''}">${task.title}</div>
                    <div class="font-mono text-[10px] font-bold text-indigo-500">${window.formatTime(task.seconds)}</div>
                    <button onclick="setActive('${task.title}')" class="p-2 ${isAct ? 'bg-indigo-600 text-white' : 'bg-indigo-50 text-indigo-600'} rounded-lg">â–¶</button>
                    <button onclick="deleteTask('${task.title}')" class="p-2 text-slate-300 hover:text-rose-500">âœ•</button>`;
                list.appendChild(div);
            });
            const total = (state.history[currentDate] || []).reduce((a, t) => a + t.seconds, 0);
            document.getElementById('global-stopwatch').innerText = window.formatTime(total);
        };

        window.updateCharts = () => {
            const tasks = state.history[currentDate] || [];
            const done = tasks.filter(t => t.completed).length, total = tasks.length || 1;
            const pct = Math.round((done / total) * 100);
            document.querySelector('#percentage-label span').innerText = `${pct}%`;
            window.initChart('todayProgressChart', 'doughnut', [done, total - done], ['#4f46e5', '#f1f5f9']);
            
            const tasksWithTime = tasks.filter(t => t.seconds > 0);
            window.initChart('pieChart', 'pie', tasksWithTime.length ? tasksWithTime.map(t => t.seconds) : [1], tasksWithTime.length ? ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'] : ['#f1f5f9'], tasksWithTime.map(t => t.title));
            
            const days = []; for(let i=6; i>=0; i--) { const d = new Date(); d.setDate(d.getDate() - i); days.push(d.toLocaleDateString('sv-SE')); }
            const barData = days.map(d => (state.history[d] || []).reduce((a, b) => a + b.seconds, 0) / 3600);
            window.initChart('weeklyChart', 'bar', barData, '#6366f1', days.map(d => d.slice(5)));
        };

        window.initChart = (id, type, data, colors, labels = []) => {
            if (charts[id]) { 
                charts[id].data.datasets[0].data = data; 
                charts[id].data.labels = labels; 
                charts[id].update(); 
            } else { 
                charts[id] = new Chart(document.getElementById(id), { 
                    type, 
                    data: { labels, datasets: [{ data, backgroundColor: colors, borderWidth: 0, borderRadius: 4 }] }, 
                    options: { maintainAspectRatio: false, plugins: { legend: { display: type === 'pie', position: 'bottom' } } } 
                }); 
            }
        };

        window.renderAnalysis = () => {
            const agg = {};
            Object.values(state.history).forEach(day => { day.forEach(t => { if(!agg[t.title]) agg[t.title] = {s:0, c:0, a:0}; agg[t.title].s += t.seconds; agg[t.title].a++; if(t.completed) agg[t.title].c++; }); });
            const table = document.getElementById('analysis-table'); table.innerHTML = '';
            Object.entries(agg).sort((a,b) => b[1].s - a[1].s).forEach(([title, d]) => {
                const pct = Math.round((d.c / d.a) * 100);
                table.innerHTML += `<tr><td class="px-6 py-4 font-bold text-slate-700">${title}</td><td class="px-6 py-4 text-indigo-500 font-mono font-bold">${window.formatTime(d.s)}</td><td class="px-6 py-4">${pct}%</td><td class="px-6 py-4"><span class="bg-indigo-50 text-indigo-600 px-2 py-1 rounded-full text-[10px] font-black uppercase">${pct >= 80 ? 'ãƒã‚¹ã‚¿ãƒ¼' : 'é€²è¡Œä¸­'}</span></td></tr>`;
            });
        };

        window.exportAsHtml = () => {
            const docClone = new DOMParser().parseFromString(document.documentElement.outerHTML, 'text/html');
            docClone.getElementById('embedded-data').textContent = JSON.stringify(state.history);
            const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob(["<!DOCTYPE html>\n" + docClone.documentElement.outerHTML], { type: 'text/html' })); a.download = `StudyTracker_Backup.html`; a.click();
        };

        // åˆæœŸåŒ–å®Ÿè¡Œ
        const init = async () => {
            await signInAnonymously(auth);
            onAuthStateChanged(auth, (user) => { state.user = user; });

            document.getElementById('date-picker').value = currentDate;
            document.getElementById('date-picker').addEventListener('change', (e) => {
                window.stopTimer();
                currentDate = e.target.value;
                window.initDayData();
                window.refreshUI();
            });

            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('key')) {
                document.getElementById('sync-key').value = urlParams.get('key').toUpperCase();
                window.openSyncModal();
            }

            window.initDayData();
            window.refreshUI();
        };
        init();
    </script>
</body>
</html>

