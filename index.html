<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Study Tracker Pro - Sync Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator@1.4.4/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=Noto+Sans+JP:wght@400;700;900&family=JetBrains+Mono:wght@500&display=swap');
        body { font-family: 'Inter', 'Noto Sans JP', sans-serif; background-color: #f8fafc; color: #1e293b; -webkit-tap-highlight-color: transparent; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        .glass-card { background: white; border-radius: 1.25rem; border: 1px solid #e2e8f0; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1); }
        .btn-hover { transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); }
        .btn-hover:active { transform: scale(0.95); }
        .active-timer { border: 2px solid #6366f1; background: #f5f7ff; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(99, 102, 241, 0); } 100% { box-shadow: 0 0 0 0 rgba(99, 102, 241, 0); } }
        .modal-overlay { background: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); }
        input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>
<body class="p-3 md:p-8 min-h-screen">

    <script id="embedded-data" type="application/json">{}</script>

    <div class="max-w-7xl mx-auto space-y-4 md:space-y-6">
        <!-- Header -->
        <header class="flex flex-col gap-4 glass-card p-4 md:p-6">
            <div class="flex flex-wrap justify-between items-center gap-4">
                <div class="flex items-center gap-3">
                    <div class="bg-indigo-600 p-2 md:p-3 rounded-xl shadow-lg">
                        <svg class="w-6 h-6 md:w-8 md:h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                    </div>
                    <div>
                        <h1 class="text-xl md:text-2xl font-black text-slate-800 tracking-tight text-shadow-sm">Study Tracker Pro</h1>
                        <p id="date-display" class="text-slate-500 text-[10px] md:text-xs font-bold uppercase tracking-wider font-mono"></p>
                    </div>
                </div>
                <div class="flex gap-2 flex-wrap">
                    <button onclick="openSyncModal()" class="bg-indigo-600 text-white px-4 py-2 rounded-xl text-sm font-bold btn-hover shadow-lg flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"></path></svg>
                        åŒæœŸè¨­å®š
                    </button>
                    <button onclick="exportAsHtml()" class="bg-emerald-600 text-white px-4 py-2 rounded-xl text-sm font-bold btn-hover shadow-lg">HTMLä¿å­˜</button>
                </div>
            </div>

            <div class="flex flex-col sm:flex-row items-center gap-4 bg-slate-50 p-3 md:p-4 rounded-2xl border border-slate-200">
                <div class="flex flex-1 justify-around w-full items-center">
                    <div class="flex flex-col items-center">
                        <span class="text-[10px] font-black text-slate-400 uppercase mb-1 tracking-widest">ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³</span>
                        <div class="flex items-center gap-2 bg-white px-3 py-1.5 rounded-xl shadow-sm border border-slate-100">
                            <input type="number" id="timer-minutes-input" value="25" min="1" class="w-12 bg-transparent text-lg font-bold text-slate-700 outline-none text-center">
                            <span class="text-slate-300 font-bold">:</span>
                            <span id="global-countdown" class="font-mono text-xl font-bold text-slate-700 w-8 text-center">00</span>
                            <button onclick="toggleGlobalTimer()" id="timer-btn" class="p-1.5 bg-indigo-100 text-indigo-600 rounded-lg btn-hover ml-1">
                                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M4.5 3a.5.5 0 00-.5.5v13a.5.5 0 00.757.429l11-6.5a.5.5 0 000-.858l-11-6.5A.5.5 0 004.5 3z"/></svg>
                            </button>
                        </div>
                    </div>
                    <div class="w-px h-10 bg-slate-200 mx-2"></div>
                    <div class="flex flex-col items-center">
                        <span class="text-[10px] font-black text-slate-400 uppercase mb-1 tracking-widest">æœ¬æ—¥ã®åˆè¨ˆå­¦ç¿’</span>
                        <div id="global-stopwatch" class="font-mono text-xl md:text-2xl font-black text-indigo-600 drop-shadow-sm">00:00:00</div>
                    </div>
                </div>
                <input type="date" id="date-picker" class="w-full sm:w-auto border border-slate-200 rounded-xl px-4 py-2 text-sm font-bold outline-none bg-white focus:ring-2 focus:ring-indigo-500/20">
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            <div class="lg:col-span-7 space-y-4">
                <section class="glass-card p-4 md:p-6">
                    <div class="flex gap-2 mb-6">
                        <input type="text" id="task-title" placeholder="æ–°ã—ã„ã‚¿ã‚¹ã‚¯å..." class="flex-1 bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm font-bold outline-none focus:ring-2 focus:ring-indigo-500/20">
                        <button onclick="addNewTask()" class="bg-indigo-600 text-white px-6 py-3 rounded-xl font-black text-sm shadow-md btn-hover">è¿½åŠ </button>
                    </div>
                    <div id="task-list" class="space-y-3"></div>
                </section>
            </div>

            <div class="lg:col-span-5 flex flex-col gap-4">
                <div class="glass-card p-4 flex flex-col items-center justify-center min-h-[160px] relative overflow-hidden">
                    <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">1é€±é–“ã®é”æˆåº¦</h3>
                    <div class="relative w-28 h-28">
                        <canvas id="weeklyProgressChart"></canvas>
                        <div id="weekly-percentage-label" class="absolute inset-0 flex items-center justify-center">
                            <span class="text-lg font-black text-indigo-600">0%</span>
                        </div>
                    </div>
                </div>
                <div class="glass-card p-4 flex flex-col items-center justify-center min-h-[160px] relative overflow-hidden">
                    <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">æœ¬æ—¥ã®é€²æ—çŠ¶æ³</h3>
                    <div class="relative w-28 h-28">
                        <canvas id="todayProgressChart"></canvas>
                        <div id="percentage-label" class="absolute inset-0 flex items-center justify-center">
                            <span class="text-lg font-black text-slate-800">0%</span>
                        </div>
                    </div>
                </div>
                <div class="glass-card p-4 flex flex-col items-center justify-center min-h-[160px]">
                    <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2">å­¦ç¿’æ™‚é–“é…åˆ†</h3>
                    <div class="relative w-full h-28">
                        <canvas id="pieChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 gap-6">
            <section class="glass-card overflow-hidden">
                <div class="p-4 border-b border-slate-100 bg-slate-50/50 flex justify-between items-center">
                    <h3 class="text-[10px] font-black text-slate-700 uppercase tracking-widest">ç´¯è¨ˆå­¦ç¿’åˆ†æ</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left min-w-[600px]">
                        <thead class="bg-slate-50 text-[10px] font-black text-slate-400 uppercase tracking-widest">
                            <tr>
                                <th class="px-6 py-4">å­¦ç¿’é …ç›®</th>
                                <th class="px-6 py-4">ç´¯è¨ˆæ™‚é–“</th>
                                <th class="px-6 py-4">é”æˆåº¦</th>
                                <th class="px-6 py-4">è©•ä¾¡</th>
                            </tr>
                        </thead>
                        <tbody id="analysis-table" class="divide-y divide-slate-100 text-sm"></tbody>
                    </table>
                </div>
            </section>
            
            <section class="glass-card p-4 md:p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-[10px] font-black text-slate-400 uppercase tracking-widest">é€±é–“å­¦ç¿’ãƒ­ã‚°</h3>
                </div>
                <div class="h-48 md:h-64">
                    <canvas id="weeklyChart"></canvas>
                </div>
            </section>
        </div>
    </div>

    <!-- Sync Modal -->
    <div id="sync-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-overlay hidden px-4">
        <div class="bg-white w-full max-w-md p-8 rounded-3xl shadow-2xl space-y-6">
            <div class="text-center">
                <h2 class="text-2xl font-black text-slate-800">ã‚¹ãƒãƒ›ãƒ»PCåŒæœŸ</h2>
                <p class="text-xs text-slate-500 font-bold mt-1 uppercase tracking-widest">Cloud Sync & QR Access</p>
            </div>
            
            <div id="qr-container" class="flex flex-col items-center bg-slate-50 p-6 rounded-2xl border-2 border-dashed border-slate-200">
                <div id="qrcode" class="bg-white p-2 rounded-xl shadow-inner mb-4"></div>
                <p class="text-[10px] text-slate-400 font-bold uppercase">ã“ã®QRã‚’ã‚¹ãƒãƒ›ã§ã‚¹ã‚­ãƒ£ãƒ³</p>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-wider block mb-1">å…±æœ‰ã‚­ãƒ¼ï¼ˆãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ï¼‰</label>
                    <div class="flex gap-2">
                        <input type="text" id="sync-key" class="flex-1 font-mono font-bold bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 outline-none focus:ring-4 focus:ring-indigo-500/10" placeholder="ä»»æ„ã®æ–‡å­—åˆ—">
                        <button onclick="generateRandomKey()" class="bg-slate-100 p-3 rounded-xl hover:bg-slate-200">ğŸ²</button>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <button onclick="uploadToCloud()" class="bg-indigo-600 text-white font-black py-4 rounded-2xl shadow-lg shadow-indigo-500/20 btn-hover text-sm">ã‚¯ãƒ©ã‚¦ãƒ‰ã¸ä¿å­˜</button>
                    <button onclick="downloadFromCloud()" class="bg-slate-800 text-white font-black py-4 rounded-2xl shadow-lg btn-hover text-sm">èª­è¾¼ï¼ˆåŒæœŸï¼‰</button>
                </div>
            </div>
            
            <button onclick="closeSyncModal()" class="w-full text-slate-400 font-bold py-2 text-sm">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <!-- Edit Modal (Legacy) -->
    <div id="manual-time-modal" class="fixed inset-0 z-50 flex items-center justify-center modal-overlay hidden px-4">
        <div class="bg-white w-full max-w-sm p-6 rounded-3xl shadow-2xl space-y-6">
            <div class="flex justify-between items-center">
                <h2 class="text-xl font-black text-slate-800">æ™‚é–“ã®æ‰‹å‹•ç·¨é›†</h2>
                <span class="text-indigo-600 bg-indigo-50 px-3 py-1 rounded-lg text-xs font-bold" id="editing-task-name"></span>
            </div>
            <div class="space-y-2">
                <label class="text-[10px] font-black text-slate-400 uppercase tracking-wider">åˆ†å˜ä½ã§å…¥åŠ›</label>
                <input type="number" id="manual-minutes" min="0" class="w-full text-3xl font-mono font-bold bg-slate-50 border border-slate-200 rounded-2xl px-4 py-3 outline-none focus:ring-4 focus:ring-indigo-500/10">
            </div>
            <div class="flex gap-3 pt-2">
                <button onclick="closeManualModal()" class="flex-1 bg-slate-100 text-slate-600 font-bold py-3 rounded-2xl btn-hover">æˆ»ã‚‹</button>
                <button onclick="saveManualTime()" class="flex-1 bg-indigo-600 text-white font-bold py-3 rounded-2xl shadow-lg shadow-indigo-500/30 btn-hover">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Global Firebase Config (Environment variables)
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'study-tracker-v5';

        // --- State Management ---
        const STORAGE_KEY = 'learning_tracker_final_v5';
        let currentDate = new Date().toLocaleDateString('sv-SE');
        const taskColors = ['#6366f1', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#f97316', '#14b8a6', '#475569'];

        const getInitialHistory = () => {
            let localData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
            try {
                const embedded = JSON.parse(document.getElementById('embedded-data').textContent || "{}");
                Object.keys(embedded).forEach(d => { if(!localData[d]) localData[d] = embedded[d]; });
            } catch(e) {}
            return localData;
        };

        let state = {
            history: getInitialHistory(),
            activeTaskId: null,
            editingTaskId: null,
            user: null
        };

        let charts = {};
        let timerInterval, timeLeft = 25 * 60, isTimerRunning = false;

        // --- Core Functions ---
        window.initApp = async () => {
            await signInAnonymously(auth);
            onAuthStateChanged(auth, (user) => { state.user = user; });

            const picker = document.getElementById('date-picker');
            picker.value = currentDate;
            picker.addEventListener('change', (e) => {
                stopTimer();
                currentDate = e.target.value;
                initDayData();
                refreshUI();
            });

            // Check if URL has a sync key
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('key')) {
                document.getElementById('sync-key').value = urlParams.get('key');
                openSyncModal();
            }

            initDayData();
            refreshUI();
            setInterval(() => {
                const total = (state.history[currentDate] || []).reduce((a, t) => a + (t.seconds || 0), 0);
                document.getElementById('global-stopwatch').innerText = formatTime(total);
            }, 1000);
        };

        window.initDayData = () => {
            if (!state.history[currentDate]) {
                const dates = Object.keys(state.history).sort();
                const lastDate = dates.filter(d => d < currentDate).pop();
                state.history[currentDate] = lastDate ? 
                    state.history[lastDate].map(t => ({ title: t.title, seconds: 0, completed: false })) : [];
                saveToLocal();
            }
        };

        window.saveToLocal = () => { localStorage.setItem(STORAGE_KEY, JSON.stringify(state.history)); };

        window.refreshUI = () => {
            renderTasks();
            updateCharts();
            renderAnalysis();
            document.getElementById('date-display').innerText = currentDate;
        };

        // --- Sync & Cloud Logic ---
        window.openSyncModal = () => {
            document.getElementById('sync-modal').classList.remove('hidden');
            updateQRCode();
        };
        window.closeSyncModal = () => document.getElementById('sync-modal').classList.add('hidden');
        
        window.generateRandomKey = () => {
            const key = Math.random().toString(36).substring(2, 8).toUpperCase();
            document.getElementById('sync-key').value = key;
            updateQRCode();
        };

        window.updateQRCode = () => {
            const key = document.getElementById('sync-key').value;
            const container = document.getElementById('qrcode');
            container.innerHTML = '';
            if (!key) return;
            
            const url = new URL(window.location.href);
            url.searchParams.set('key', key);
            
            const qr = qrcode(0, 'M');
            qr.addData(url.toString());
            qr.make();
            container.innerHTML = qr.createImgTag(5);
        };

        window.uploadToCloud = async () => {
            const key = document.getElementById('sync-key').value;
            if (!key || !state.user) return alert("å…±æœ‰ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            
            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = "ä¿å­˜ä¸­...";
            
            try {
                // RULE 1: Specific path for public data
                const syncDoc = doc(db, 'artifacts', appId, 'public', 'data', key);
                await setDoc(syncDoc, { 
                    history: state.history, 
                    updatedAt: new Date().toISOString() 
                });
                alert("ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ã—ã¾ã—ãŸã€‚ã“ã®ã‚­ãƒ¼ã§ä»–ãƒ‡ãƒã‚¤ã‚¹ã‹ã‚‰åŒæœŸã§ãã¾ã™ã€‚");
            } catch (e) {
                alert("ä¿å­˜ã‚¨ãƒ©ãƒ¼: " + e.message);
            } finally {
                btn.innerText = originalText;
                updateQRCode();
            }
        };

        window.downloadFromCloud = async () => {
            const key = document.getElementById('sync-key').value;
            if (!key || !state.user) return alert("å…±æœ‰ã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„");
            
            try {
                const syncDoc = doc(db, 'artifacts', appId, 'public', 'data', key);
                const snap = await getDoc(syncDoc);
                if (snap.exists()) {
                    state.history = snap.data().history;
                    saveToLocal();
                    refreshUI();
                    alert("åŒæœŸãŒå®Œäº†ã—ã¾ã—ãŸï¼");
                    closeSyncModal();
                } else {
                    alert("ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ã‚­ãƒ¼ãŒæ­£ã—ã„ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                }
            } catch (e) {
                alert("åŒæœŸã‚¨ãƒ©ãƒ¼: " + e.message);
            }
        };

        // --- Task & UI Logic (Keeping everything same) ---
        window.addNewTask = () => {
            const input = document.getElementById('task-title');
            const title = input.value.trim();
            if (!title) return;
            Object.keys(state.history).forEach(d => {
                if (d >= currentDate && !state.history[d].some(t => t.title === title)) {
                    state.history[d].push({ title, seconds: 0, completed: false });
                }
            });
            input.value = ''; saveToLocal(); refreshUI();
        };

        window.deleteTask = (title) => {
            Object.keys(state.history).forEach(d => {
                if (d >= currentDate) state.history[d] = state.history[d].filter(t => t.title !== title);
            });
            if (state.activeTaskId === title) stopTimer();
            saveToLocal(); refreshUI();
        };

        window.toggleTask = (title) => {
            state.history[currentDate] = state.history[currentDate].map(t => t.title === title ? {...t, completed: !t.completed} : t);
            saveToLocal(); refreshUI();
        };

        window.renderTasks = () => {
            const list = document.getElementById('task-list');
            list.innerHTML = '';
            (state.history[currentDate] || []).forEach(task => {
                const isActive = state.activeTaskId === task.title;
                const div = document.createElement('div');
                div.className = `flex items-center gap-2 p-3 rounded-2xl border transition-all ${isActive ? 'active-timer shadow-md' : 'bg-white border-slate-200'} ${task.completed ? 'opacity-50' : ''}`;
                div.dataset.title = task.title;
                div.innerHTML = `
                    <div class="drag-handle text-slate-300 cursor-grab px-1">â‹®â‹®</div>
                    <input type="checkbox" ${task.completed ? 'checked' : ''} onchange="toggleTask('${task.title}')" class="w-5 h-5 accent-indigo-600 rounded-lg">
                    <div class="flex-1 truncate font-bold text-slate-700 text-sm ${task.completed ? 'line-through opacity-50' : ''}">${task.title}</div>
                    <div class="font-mono text-[10px] font-bold text-indigo-500 bg-indigo-50 px-2 py-1 rounded-md">${formatTime(task.seconds)}</div>
                    <div class="flex items-center gap-1">
                        <button onclick="openManualModal('${task.title}')" class="p-2 text-slate-400 hover:text-indigo-600">âœ</button>
                        <button onclick="state.activeTaskId='${task.title}'; refreshUI();" class="p-2 ${isActive ? 'bg-indigo-600 text-white' : 'bg-indigo-50 text-indigo-600'} rounded-lg shadow-sm">
                            <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M4.5 3a.5.5 0 00-.5.5v13a.5.5 0 00.757.429l11-6.5a.5.5 0 000-.858l-11-6.5A.5.5 0 004.5 3z"/></svg>
                        </button>
                        <button onclick="deleteTask('${task.title}')" class="p-2 text-slate-300 hover:text-rose-500">âœ•</button>
                    </div>
                `;
                list.appendChild(div);
            });
            new Sortable(list, { animation: 200, handle: '.drag-handle' });
        };

        window.openManualModal = (title) => {
            state.editingTaskId = title;
            document.getElementById('editing-task-name').innerText = title;
            const task = state.history[currentDate].find(t => t.title === title);
            document.getElementById('manual-minutes').value = Math.floor(task.seconds / 60);
            document.getElementById('manual-time-modal').classList.remove('hidden');
        };
        window.closeManualModal = () => document.getElementById('manual-time-modal').classList.add('hidden');
        window.saveManualTime = () => {
            const mins = parseInt(document.getElementById('manual-minutes').value) || 0;
            state.history[currentDate] = state.history[currentDate].map(t => t.title === state.editingTaskId ? {...t, seconds: mins * 60} : t);
            saveToLocal(); refreshUI(); closeManualModal();
        };

        window.toggleGlobalTimer = () => { if (!state.activeTaskId) return; isTimerRunning ? stopTimer() : startTimer(); };
        window.startTimer = () => {
            const input = document.getElementById('timer-minutes-input');
            if (!isTimerRunning && timeLeft === 25 * 60) timeLeft = (parseInt(input.value) || 25) * 60;
            isTimerRunning = true;
            timerInterval = setInterval(() => {
                if (timeLeft > 0) {
                    timeLeft--;
                    const task = (state.history[currentDate] || []).find(t => t.title === state.activeTaskId);
                    if (task) task.seconds++;
                    saveToLocal(); updateTimerUI();
                } else { stopTimer(); }
            }, 1000);
            updateTimerButton();
        };
        window.stopTimer = () => { clearInterval(timerInterval); isTimerRunning = false; updateTimerButton(); };
        window.updateTimerUI = () => { 
            const m = Math.floor(timeLeft / 60), s = timeLeft % 60;
            document.getElementById('timer-minutes-input').value = m;
            document.getElementById('global-countdown').innerText = String(s).padStart(2, '0');
            refreshUI();
        };
        window.updateTimerButton = () => {
            const btn = document.getElementById('timer-btn');
            btn.innerHTML = isTimerRunning ? `<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M5 4a1 1 0 00-1 1v10a1 1 0 001 1h3a1 1 0 001-1V5a1 1 0 00-1-1H5zm7 0a1 1 0 00-1 1v10a1 1 0 001 1h3a1 1 0 001-1V5a1 1 0 00-1-1h-3z"/></svg>` : `<svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20"><path d="M4.5 3a.5.5 0 00-.5.5v13a.5.5 0 00.757.429l11-6.5a.5.5 0 000-.858l-11-6.5A.5.5 0 004.5 3z"/></svg>`;
        };
        window.formatTime = (sec) => {
            const h = Math.floor(sec / 3600), m = Math.floor((sec % 3600) / 60), s = sec % 60;
            return [h, m, s].map(v => String(v).padStart(2, '0')).join(":");
        };

        window.updateCharts = () => {
            const tasks = state.history[currentDate] || [];
            const done = tasks.filter(t => t.completed).length, total = tasks.length || 1;
            const pct = Math.round((done / total) * 100);
            document.querySelector('#percentage-label span').innerText = `${pct}%`;
            initChart('todayProgressChart', 'doughnut', [done, total - done], ['#4f46e5', '#f1f5f9']);
            
            const days = [];
            for(let i=6; i>=0; i--) { const d = new Date(); d.setDate(d.getDate() - i); days.push(d.toLocaleDateString('sv-SE')); }
            let weekDone = 0, weekTotal = 0;
            days.forEach(d => { const dayTasks = state.history[d] || []; weekDone += dayTasks.filter(t => t.completed).length; weekTotal += dayTasks.length; });
            const weekPct = weekTotal === 0 ? 0 : Math.round((weekDone / weekTotal) * 100);
            document.querySelector('#weekly-percentage-label span').innerText = `${weekPct}%`;
            initChart('weeklyProgressChart', 'doughnut', [weekDone, weekTotal - weekDone || 1], ['#6366f1', '#f1f5f9']);

            const tasksWithTime = tasks.filter(t => t.seconds > 0);
            if(tasksWithTime.length > 0) {
                const colors = tasksWithTime.map((t, i) => taskColors[i % taskColors.length]);
                initChart('pieChart', 'pie', tasksWithTime.map(t => t.seconds), colors, tasksWithTime.map(t => t.title));
            } else { initChart('pieChart', 'pie', [1], ['#f1f5f9'], ['ãƒ‡ãƒ¼ã‚¿ãªã—']); }
            
            const barData = days.map(d => (state.history[d] || []).reduce((a, b) => a + (b.seconds || 0), 0) / 3600);
            initChart('weeklyChart', 'bar', barData, '#6366f1', days.map(d => d.slice(5)));
        };

        window.initChart = (id, type, data, colors, labels = []) => {
            if (charts[id]) {
                charts[id].data.datasets[0].data = data;
                charts[id].data.datasets[0].backgroundColor = colors;
                charts[id].data.labels = labels;
                charts[id].update();
            } else {
                charts[id] = new Chart(document.getElementById(id), {
                    type, data: { labels, datasets: [{ data, backgroundColor: colors, borderWidth: 0, borderRadius: type === 'bar' ? 6 : 0 }] },
                    options: { maintainAspectRatio: false, plugins: { legend: { display: type === 'pie', position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } } }, scales: type === 'bar' ? { y: { beginAtZero: true } } : {} }
                });
            }
        };

        window.renderAnalysis = () => {
            const agg = {};
            Object.values(state.history).forEach(day => {
                day.forEach(t => { if (!agg[t.title]) agg[t.title] = { s: 0, c: 0, a: 0 }; agg[t.title].s += t.seconds; agg[t.title].a++; if (t.completed) agg[t.title].c++; });
            });
            const table = document.getElementById('analysis-table');
            table.innerHTML = '';
            Object.entries(agg).sort((a,b) => b[1].s - a[1].s).forEach(([title, d]) => {
                const pct = Math.round((d.c / d.a) * 100);
                let status = pct >= 80 ? { t: 'ãƒã‚¹ã‚¿ãƒ¼', c: 'bg-emerald-100 text-emerald-700' } : (pct < 40 ? { t: 'è¦æ”¹å–„', c: 'bg-rose-100 text-rose-700' } : { t: 'ç¶™ç¶šä¸­', c: 'bg-amber-100 text-amber-700' });
                table.innerHTML += `<tr><td class="px-6 py-4 font-bold text-slate-700">${title}</td><td class="px-6 py-4 font-mono font-bold text-indigo-500">${formatTime(d.s)}</td><td class="px-6 py-4"><div class="flex items-center gap-2"><div class="w-16 h-1 bg-slate-100 rounded-full overflow-hidden"><div class="h-full bg-indigo-500" style="width:${pct}%"></div></div><span class="text-[10px] font-black text-slate-400">${pct}%</span></div></td><td class="px-6 py-4"><span class="${status.c} px-2 py-1 rounded-full text-[10px] font-black uppercase tracking-tighter">${status.t}</span></td></tr>`;
            });
        };

        window.exportAsHtml = () => {
            const data = localStorage.getItem(STORAGE_KEY) || "{}";
            const docClone = new DOMParser().parseFromString(document.documentElement.outerHTML, 'text/html');
            docClone.getElementById('embedded-data').textContent = data;
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob(["<!DOCTYPE html>\n" + docClone.documentElement.outerHTML], { type: 'text/html' }));
            a.download = `StudyTracker_Sync_${currentDate}.html`;
            a.click();
        };

        // Start initialization
        initApp();
    </script>
</body>
</html>

